#include <stdio.h>

#include "Extract_table_info.h"
#include "utils/elog.h"             //ereport defined here
#include "nodes/pg_list.h"          //foreach defined here

//#define file_name "/home/deepaks/table_oid_name.txt"

//FILE *fp;


/***********************Checking if it is a select query************************/

bool is_select_command(const char *query)
{

        /* skip comment */
    query = skip_comment(query);

        if (*query == '\0')
                return false;

        /* skip spaces */
        while (*query && isspace(*query))
                query++;

        /* SELECT? */
        if (strncasecmp("SELECT", query, 6))	//returns false if a match
                return false;

        return true;				//returns true if it is a select command
}

/**************************Skipping comments of a query**********************************/

/* skip SQL comments */
char *skip_comment(char *query)
{
	if (strncmp(query, "/*", 2) == 0)
	{
		query += 2;
		while (query)
		{
			if (strncmp(query, "*/", 2) == 0)
			{
				query += 2;
				break;
			}
			query++;
		}
	}
	return query;
}

/*******************Extracting table name and oid and writing to a file**********************/

void extract_table_oid_name(const char *query, const List *rtable)
{
    const ListCell *l;

    fp = fopen(file_name,"a");

    if (fp == NULL)             //returns NULL or 0 if file doesn't open
        {
            ereport(ERROR, (errmsg("Error opening file \"%s\"",file_name)));
        }
    else
        {
            foreach(l, rtable)
                {
                    RangeTblEntry *rte = lfirst(l);         //header not added

                  //  fprintf(fp, "%s %d", rte->eref->aliasname, rte->relid);

                    client_main(query, (int)rte->relid);

                }
        }
    if(fclose(fp))           //returns 0 if successful
        {
            ereport(ERROR, (errmsg("Error closing file \"%s\"",file_name)));
        }
}

/*************************************************************************************************/

